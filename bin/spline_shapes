#!/usr/bin/env python
import pycedar
import gzip
import pandas as pd
import logging
import matplotlib.pyplot as plt
import cProfile
import sys
import numpy as np
import os.path as osp

def plot_splines( m, ax ):
    spline_templates = pycedar.load_templates_csv(
            m['spline_data']).loc[ m['spline_diaphragm'], : , :]

    print( spline_templates )

    asym_aligner = pycedar.AsymAligner(
            wideset = m['wide_data'], 
            spline_range = m['spline_range'],
            spline_smoothing = m['spline_smoothing'],
            spline_step = m['spline_step'])

    xfile = osp.join( m['ofolder'], m['prefix'] + 'xfile.pdf' )
    yfile = osp.join( m['ofolder'], m['prefix'] + 'yfile.pdf' )

    asym_aligner.set_templates( spline_templates )
    asym_aligner.prepare_templates()

    ax.grid( True )
    asym_aligner.plot_xinvspline( ax )
    ax.set_title( '{0} mm diaphragm'.format( 0.001 * 1500  ) )
    plt.savefig( xfile, format = 'pdf' , transparent = 'true' )
    ax.cla()

    ax.grid( True )
    ax.set_title( '{0} mm diaphragm'.format( 0.001 * 1500  ) )
    asym_aligner.plot_yinvspline( ax )
    plt.savefig( yfile, format = 'pdf' , transparent = 'true' )
    ax.cla()

#--------------------------------------------------


wide_data = pycedar.load_templates_csv( 
        gzip.open( 'data/align_csv/kaonp_1710_20000_42.csv.gz' ) 
        ).loc[20000, :, : ] 

base_map =  {
        'wide_data' : wide_data,
        'spline_range' : 1300,
        'spline_smoothing' : 80,
        'spline_step' :  50,
        'ofolder' : 'output/spline_shapes',
        }

fig = plt.figure( figsize = [6, 6] )
fig.set_tight_layout(True)
ax = fig.add_subplot( 111 )

plan_1500 = base_map.copy()
plan_1500['spline_data'] = 'data/align_csv/kaonp_1710_1500_splines.csv.gz'
plan_1500['spline_diaphragm'] = 1500
plan_1500['prefix'] = 'spline_1500_stat_'

plot_splines( plan_1500, ax )
